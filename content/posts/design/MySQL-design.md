---
title: "MySQL系统设计"
date: 2021-12-28T15:13:44+08:00
draft: false
categories: ["MySQL", "系统设计"]
---

# MySQL系统设计

## 一、设计要素

### 1.1、基础设计

- 根据业务模式，设计库表结构
- 根据访问模式，设计索引结构

### 1.2、拓展设计

- 读性能
- 高可用
- 数据一致性
- 垂直拆分
- 水平拆分

### 1.3、设计思考

1. 设计解决什么问题？
2. 引入什么新的问题？
3. 如何折衷考虑与解决？

**ps：任何技术引入都将引入新问题**

## 二、读性能提升

### 2.1、思考



### 2.2、方案

### 2.2.1、新增索引

- 问题
  - 写性能下降：写库表时，同步索引将对性能有所损耗
  - 读性能下降：索引设计不合理，索引占据大量内存，缓存命中率将下降

### 2.2.2、主从架构，增加从库

- 思路一：主从分离，主写从读
  - 问题1：从库太多，导致主从延时增大，不一致问题变大
  - 问题2: 写压力并未降低
- 思路二：主从分离，从库根据用途决定索引结构
  - 问题：运维成本高，有强状态，导致扩容不方便

### 2.2.3、新增缓存，防止雪崩

- 思路：先读缓存，再读主
  - 问题：从库作用降低



## 三、垂直拆分与高可用

### 3.1、垂直拆分

垂直拆分方法论：长度较短、访问频率较高、经常一起访问放主表

将库/表进行拆分

- 拆库：按业务拆库
- 拆表：大表拆小表
  - 大表会加剧io瓶颈，缓存命中率（数据库页加载-预取）会降低

### 3.2、高可用

高可用方法论：冗余和故障转移

问题：数据库有状态，冗余就会引发一致性问题

- 从库高可用冗余从库
- 主库高可用冗余主库



## 四、数据库一致性

- 情况一：主从数据冗余，主从数据不一致 
  - 方案一：忽略不计 
  - 方案二：强制读主 
  - 方案三：选择性读主

- 情况二：主主冗余，主主数据不一致 
  - 方案一：ID冲突，不同初始值，相同递增步长 
  - 方案二：分布式ID，雪花 方案三 单主服务，影子主不服务
- 情况三：缓存冗余，数据库与缓存不一致

### 五、水平拆分

- 场景
  - 场景一：数据结构变更，表结构变化
    - 直接线上改表结构会锁表
  - 场景二：新增从库
  - 场景三：存储介质变化
- 方案
  - 方案一：停服更新
  - 方案二：online schema change
    - 步骤一：创建新库
    - 步骤二：创建触发器同步数据
    - 步骤三：锁A库，改为readonly
    - 步骤四：B库rename
    - 步骤五：切流量
  - 方案三：追日志
