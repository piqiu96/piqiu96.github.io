<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>MySQL优化 - 阿邱爷｜Blog</title><meta name="Description" content="这是我的全新 Hugo 网站"><meta property="og:title" content="MySQL优化" />
<meta property="og:description" content="SQL优化 Sql执行顺序 (8) SELECT(9) DISTINCT column,… 选择字段 、去重 (6) AGG_FUNC(column or expression),… 聚合函数 (1) FROM [left_table] 选择表 (3) &lt;join_type&gt; JOIN &lt;right_table&gt; 链接 (2) ON &lt;join_condition&gt; 链接条件 (4)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/mysql-sqlbest/" /><meta property="og:image" content="http://example.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-04T23:32:06+08:00" />
<meta property="article:modified_time" content="2022-01-04T23:32:06+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/logo.png"/>

<meta name="twitter:title" content="MySQL优化"/>
<meta name="twitter:description" content="SQL优化 Sql执行顺序 (8) SELECT(9) DISTINCT column,… 选择字段 、去重 (6) AGG_FUNC(column or expression),… 聚合函数 (1) FROM [left_table] 选择表 (3) &lt;join_type&gt; JOIN &lt;right_table&gt; 链接 (2) ON &lt;join_condition&gt; 链接条件 (4)"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/mysql-sqlbest/" /><link rel="prev" href="http://example.org/%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1/" /><link rel="next" href="http://example.org/mysql-index/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "MySQL优化",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/mysql-sqlbest\/"
        },"genre": "posts","wordcount":  5156 ,
        "url": "http:\/\/example.org\/mysql-sqlbest\/","datePublished": "2022-01-04T23:32:06+08:00","dateModified": "2022-01-04T23:32:06+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "皮邱"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="阿邱爷｜Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/user/aq_avatar.jpeg"
        data-srcset="/images/user/aq_avatar.jpeg, /images/user/aq_avatar.jpeg 1.5x, /images/user/aq_avatar.jpeg 2x"
        data-sizes="auto"
        alt="/images/user/aq_avatar.jpeg"
        title="/images/user/aq_avatar.jpeg" />阿邱爷</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="阿邱爷｜Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/user/aq_avatar.jpeg"
        data-srcset="/images/user/aq_avatar.jpeg, /images/user/aq_avatar.jpeg 1.5x, /images/user/aq_avatar.jpeg 2x"
        data-sizes="auto"
        alt="/images/user/aq_avatar.jpeg"
        title="/images/user/aq_avatar.jpeg" />阿邱爷</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">MySQL优化</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>皮邱</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-01-04">2022-01-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5156 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#查询sql尽量不要使用select-而是具体字段">查询SQL尽量不要使用select *，而是具体字段</a></li>
    <li><a href="#避免在where子句中使用or来连接条件">避免在where子句中使用or来连接条件</a></li>
    <li><a href="#使用varchar代替char">使用varchar代替char</a></li>
    <li><a href="#heading"></a></li>
    <li><a href="#尽量使用数值替代字符串类型">尽量使用数值替代字符串类型</a></li>
    <li><a href="#查询尽量避免返回大量数据">查询尽量避免返回大量数据</a></li>
    <li><a href="#使用explain分析你sql执行计划">使用explain分析你SQL执行计划</a></li>
    <li><a href="#是否使用了索引及其扫描类型">是否使用了索引及其扫描类型</a></li>
    <li><a href="#创建name字段的索引">创建name字段的索引</a></li>
    <li><a href="#优化like语句">优化like语句：</a></li>
    <li><a href="#字符串怪现象">字符串怪现象</a></li>
    <li><a href="#heading-1"></a></li>
    <li><a href="#索引不宜太多一般5个以内">索引不宜太多，一般5个以内</a></li>
    <li><a href="#heading-2"></a></li>
    <li><a href="#索引不适合建在有大量重复数据的字段上">索引不适合建在有大量重复数据的字段上</a></li>
    <li><a href="#where限定查询的数据">where限定查询的数据</a></li>
    <li><a href="#heading-3"></a></li>
    <li><a href="#避免在索引列上使用内置函数">避免在索引列上使用内置函数</a></li>
    <li><a href="#避免在where中对字段进行表达式操作">避免在where中对字段进行表达式操作</a></li>
    <li><a href="#避免在where子句中使用或操作符">避免在where子句中使用!=或&lt;&gt;操作符</a></li>
    <li><a href="#去重distinct过滤字段要少">去重distinct过滤字段要少</a></li>
    <li><a href="#where中使用默认值代替null">where中使用默认值代替null</a></li>
  </ul>

  <ul>
    <li><a href="#批量插入性能提升">批量插入性能提升</a></li>
    <li><a href="#批量删除优化">批量删除优化</a></li>
    <li><a href="#伪删除设计">伪删除设计</a></li>
    <li><a href="#heading-5"></a></li>
    <li><a href="#提高group-by语句的效率">提高group by语句的效率</a></li>
    <li><a href="#复合索引最左特性">复合索引最左特性</a></li>
    <li><a href="#heading-6"></a></li>
    <li><a href="#排序字段创建索引">排序字段创建索引</a></li>
    <li><a href="#删除冗余和重复的索引">删除冗余和重复的索引</a></li>
    <li><a href="#不要有超过5个以上的表连接">不要有超过5个以上的表连接</a></li>
    <li><a href="#inner-join-left-joinright-join优先使用inner-join">inner join 、left join、right join，优先使用inner join</a></li>
    <li><a href="#heading-7"></a></li>
    <li><a href="#in子查询的优化">in子查询的优化</a></li>
    <li><a href="#尽量使用union-all替代union">尽量使用union all替代union</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="sql优化">SQL优化</h1>
<h1 id="sql执行顺序">Sql执行顺序</h1>
<ul>
<li>(8) <code>SELECT</code>(9) <code>DISTINCT</code> column,…
选择字段 、去重</li>
<li>(6) <code>AGG_FUNC(column or expression)</code>,…
聚合函数</li>
<li>(1) <code>FROM [left_table]</code>
选择表</li>
<li>(3) &lt;join_type&gt; <code>JOIN</code> &lt;right_table&gt;
链接</li>
<li>(2) <code>ON</code> &lt;join_condition&gt;
链接条件</li>
<li>(4) <code>WHERE</code> &lt;where_condition&gt;
条件过滤</li>
<li>(5) <code>GROUP BY</code> &lt;group_by_list&gt;
分组</li>
<li>(7) <code>HAVING</code> &lt;having_condition&gt;
分组过滤</li>
<li>(10) <code>ORDER BY</code> &lt;order_by_list&gt;
排序</li>
<li>(11) <code>LIMIT</code> count OFFSET count;
分页</li>
</ul>
<h1 id="基础sql优化">基础Sql优化</h1>
<h2 id="查询sql尽量不要使用select-而是具体字段">查询SQL尽量不要使用select *，而是具体字段</h2>
<p>反例：</p>
<p>SELECT * FROM student</p>
<p>正例：</p>
<p>SELECT id,NAME FROM student</p>
<p>理由：</p>
<ul>
<li>字段多时，大表能达到100多个字段甚至达200多个字段</li>
<li>只取需要的字段，节省资源、减少网络开销</li>
<li>select * 进行查询时，很可能不会用到索引，就会造成全表扫描</li>
</ul>
<h2 id="避免在where子句中使用or来连接条件">避免在where子句中使用or来连接条件</h2>
<p>查询id为1或者薪水为3000的用户：</p>
<p>反例：</p>
<p>SELECT * FROM student WHERE id=1 OR salary=30000</p>
<p>正例：
使用union all</p>
<p>SELECT * FROM student WHERE id=1</p>
<p>UNION ALL</p>
<p>SELECT * FROM student WHERE salary=30000</p>
<p>分开两条sql写</p>
<p>SELECT * FROM student WHERE id=1</p>
<p>SELECT * FROM student WHERE salary=30000</p>
<p>理由：</p>
<ul>
<li>使用or可能会使索引失效，从而全表扫描</li>
<li>对于or没有索引的salary这种情况，假设它走了id的索引，但是走到salary查询条件时，它还得全表扫描。也就是说整个过程需要三步：全表扫描+索引扫描+合并。如果它一开始就走全表扫描，直接一遍扫描就搞定。虽然mysql是有优化器的，处于效率与成本考虑，遇到or条件，索引还是可能失效的</li>
</ul>
<h2 id="使用varchar代替char">使用varchar代替char</h2>
<p>反例：</p>
<p><code>deptname</code> char(100) DEFAULT NULL COMMENT &lsquo;部门名称&rsquo;</p>
<p><strong>正例：</strong></p>
<p><code>deptname</code> varchar(100) DEFAULT NULL COMMENT &lsquo;部门名称&rsquo;</p>
<p>理由：</p>
<ul>
<li>varchar变长字段按数据内容实际长度存储，存储空间小，可以节省存储空间</li>
<li>char按声明大小存储，不足补空格</li>
<li>其次对于查询来说，在一个相对较小的字段内搜索，效率更高</li>
</ul>
<h2 id="heading"></h2>
<h2 id="尽量使用数值替代字符串类型">尽量使用数值替代字符串类型</h2>
<ul>
<li>主键（id）：primary key优先使用数值类型int，tinyint</li>
<li>性别（sex）：0-代表女，1-代表男；数据库没有布尔类型，mysql推荐使用tinyint</li>
<li>支付方式（payment）：1-现金、2-微信、3-支付宝、4-信用卡、5-银行卡</li>
<li>服务状态（state）：1-开启、2-暂停、3-停止</li>
<li>商品状态（state）：1-上架、2-下架、3-删除</li>
</ul>
<h2 id="查询尽量避免返回大量数据">查询尽量避免返回大量数据</h2>
<p>如果查询返回数据量很大，就会造成查询时间过长，网络传输时间过长。同时，大量数据返回也可能没有实际意义。如返回上千条甚至更多，用户也看不过来。
通常采用分页，一页习惯10/20/50/100条。</p>
<h2 id="使用explain分析你sql执行计划">使用explain分析你SQL执行计划</h2>
<p>SQL很灵活，一个需求可以很多实现，那哪个最优呢？SQL提供了explain关键字，它可以分析你的SQL执行计划，看它是否最佳。Explain主要看SQL是否使用了索引。</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE id=1</p>
<p>返回结果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111204.18237127036943912923263679436760:50521228062829:2800:76234CF68DA582ADEBEF874BB15C994D33D7447FABD28442AF7068D84873C5AE.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111204.18237127036943912923263679436760:50521228062829:2800:76234CF68DA582ADEBEF874BB15C994D33D7447FABD28442AF7068D84873C5AE.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111204.18237127036943912923263679436760:50521228062829:2800:76234CF68DA582ADEBEF874BB15C994D33D7447FABD28442AF7068D84873C5AE.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111204.18237127036943912923263679436760:50521228062829:2800:76234CF68DA582ADEBEF874BB15C994D33D7447FABD28442AF7068D84873C5AE.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111204.18237127036943912923263679436760:50521228062829:2800:76234CF68DA582ADEBEF874BB15C994D33D7447FABD28442AF7068D84873C5AE.png"
        title="img" /></p>
<h2 id="是否使用了索引及其扫描类型">是否使用了索引及其扫描类型</h2>
<p>SQL索引概念（详解B+树）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">type：
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ALL</p>
<p>全表扫描，没有优化，最慢的方式</p>
</li>
<li>
<p>index</p>
<p>索引全扫描</p>
</li>
<li>
<p>range</p>
<p>索引范围扫描，常用语&lt;，&lt;=，&gt;=，between等操作</p>
</li>
<li>
<p>ref</p>
<p>使用非唯一索引扫描或唯一索引前缀扫描，返回单条记录，常出现在关联查询中</p>
</li>
<li>
<p>eq_ref</p>
<p>类似ref，区别在于使用的是唯一索引，使用主键的关联查询</p>
</li>
<li>
<p>const</p>
<p>当查询是对主键或者唯一键进行精确查询，系统会把匹配行中的其他列作为常数处理</p>
</li>
<li>
<p>null MySQL</p>
<p>不访问任何表或索引，直接返回结果</p>
</li>
<li>
<p>System 表只有一条记录(实际中基本不存在这个情况)</p>
</li>
</ul>
<blockquote>
<p>性能排行：
System &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">possible_keys：
</code></pre></td></tr></table>
</div>
</div><ul>
<li>显示可能应用在这张表中的索引</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">key：
</code></pre></td></tr></table>
</div>
</div><ul>
<li>真正使用的索引方式</li>
</ul>
<h2 id="创建name字段的索引">创建name字段的索引</h2>
<p>提高查询速度的最简单最佳的方式</p>
<p>ALTER TABLE student ADD INDEX index_name (NAME)</p>
<h2 id="优化like语句">优化like语句：</h2>
<p>模糊查询，程序员最喜欢的就是使用like，但是like很可能让你的索引失效</p>
<p>反例：</p>
<p><strong>反例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student WHERE NAME LIKE &lsquo;%1&rsquo;</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student WHERE NAME LIKE &lsquo;%1%&rsquo;</p>
<p><strong>正例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student WHERE NAME LIKE &lsquo;1%&rsquo;</p>
<p><strong>理由：</strong></p>
<p>未使用索引：故意使用sex非索引字段</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student WHERE NAME=1 OR sex=1</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111356.39863519415012733987118882966912:50521228062829:2800:2D342C8640AA3821DB14FEB248F1408834153D38B48EED3A2902930F312DFBC3.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111356.39863519415012733987118882966912:50521228062829:2800:2D342C8640AA3821DB14FEB248F1408834153D38B48EED3A2902930F312DFBC3.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111356.39863519415012733987118882966912:50521228062829:2800:2D342C8640AA3821DB14FEB248F1408834153D38B48EED3A2902930F312DFBC3.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111356.39863519415012733987118882966912:50521228062829:2800:2D342C8640AA3821DB14FEB248F1408834153D38B48EED3A2902930F312DFBC3.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111356.39863519415012733987118882966912:50521228062829:2800:2D342C8640AA3821DB14FEB248F1408834153D38B48EED3A2902930F312DFBC3.png"
        title="img" /></p>
<p>主键索引生效</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student WHERE id=1</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111411.46067537915041441861044073375128:50521228062829:2800:19F06774582A18932088538B3CDC257E8B73C4A6102FB343259ED772226F71D6.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111411.46067537915041441861044073375128:50521228062829:2800:19F06774582A18932088538B3CDC257E8B73C4A6102FB343259ED772226F71D6.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111411.46067537915041441861044073375128:50521228062829:2800:19F06774582A18932088538B3CDC257E8B73C4A6102FB343259ED772226F71D6.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111411.46067537915041441861044073375128:50521228062829:2800:19F06774582A18932088538B3CDC257E8B73C4A6102FB343259ED772226F71D6.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111411.46067537915041441861044073375128:50521228062829:2800:19F06774582A18932088538B3CDC257E8B73C4A6102FB343259ED772226F71D6.png"
        title="img" /></p>
<p>索引失效，type=ALL，全表扫描</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student WHERE id LIKE &lsquo;%1&rsquo;</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111427.71603680519366143113156873361784:50521228062829:2800:1C1CA6AAF123AB4612E5C3004489FD8F9D4E6A12608F76B610ED7BC96E935E36.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111427.71603680519366143113156873361784:50521228062829:2800:1C1CA6AAF123AB4612E5C3004489FD8F9D4E6A12608F76B610ED7BC96E935E36.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111427.71603680519366143113156873361784:50521228062829:2800:1C1CA6AAF123AB4612E5C3004489FD8F9D4E6A12608F76B610ED7BC96E935E36.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111427.71603680519366143113156873361784:50521228062829:2800:1C1CA6AAF123AB4612E5C3004489FD8F9D4E6A12608F76B610ED7BC96E935E36.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111427.71603680519366143113156873361784:50521228062829:2800:1C1CA6AAF123AB4612E5C3004489FD8F9D4E6A12608F76B610ED7BC96E935E36.png"
        title="img" /></p>
<h2 id="字符串怪现象">字符串怪现象</h2>
<p>反例：</p>
<p>#未使用索引</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE NAME=123</p>
<p><strong>正例：</strong></p>
<p>#使用索引</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE NAME=&lsquo;123&rsquo;</p>
<p>理由：</p>
<ul>
<li>为什么第一条语句未加单引号就不走索引了呢？这是因为不加单引号时，是字符串跟数字的比较，它们类型不匹配，MySQL会做隐式的类型转换，把它们转换为数值类型再做比较</li>
</ul>
<h2 id="heading-1"></h2>
<h2 id="索引不宜太多一般5个以内">索引不宜太多，一般5个以内</h2>
<ul>
<li>索引并不是越多越好，虽其提高了查询的效率，但却会降低插入和更新的效率</li>
<li>索引可以理解为一个就是一张表，其可以存储数据，其数据就要占空间</li>
<li>再者，索引表的一个特点，其数据是排序的，那排序要不要花时间呢？肯定要</li>
<li>insert或update时有可能会重建索引，如果数据量巨大，重建将进行记录的重新排序，所以建索引需要慎重考虑，视具体情况来定</li>
<li>一个表的索引数最好不要超过5个，若太多需要考虑一些索引是否有存在的必要</li>
</ul>
<h2 id="heading-2"></h2>
<h2 id="索引不适合建在有大量重复数据的字段上">索引不适合建在有大量重复数据的字段上</h2>
<p>如性别字段。因为SQL优化器是根据表中数据量来进行查询优化的，如果索引
列有大量重复数据，Mysql查询优化器推算发现不走索引的成本更低，很可能就放弃索引了。</p>
<h2 id="where限定查询的数据">where限定查询的数据</h2>
<p>数据中假定就一个男的记录</p>
<p>反例：</p>
<p>SELECT id,NAME FROM student WHERE sex=&lsquo;男&rsquo;</p>
<p><strong>正例：</strong></p>
<p>SELECT id,NAME FROM student WHERE id=1 AND sex=&lsquo;男&rsquo;</p>
<p>理由：</p>
<ul>
<li>需要什么数据，就去查什么数据，避免返回不必要的数据，节省开销</li>
</ul>
<h2 id="heading-3"></h2>
<h2 id="避免在索引列上使用内置函数">避免在索引列上使用内置函数</h2>
<p>业务需求：查询最近七天内新生儿（用学生表替代下）</p>
<p>给birthday字段创建索引：</p>
<p>ALTER TABLE student ADD INDEX idx_birthday (birthday)</p>
<p><strong>当前时间加7天：</strong></p>
<p>SELECT NOW()</p>
<p>SELECT DATE_ADD(NOW(), INTERVAL 7 DAY)</p>
<p><strong>反例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT * FROM student</p>
<p>WHERE DATE_ADD(birthday,INTERVAL 7 DAY) &gt;=NOW();</p>
<p><strong>正例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT * FROM student</p>
<p>WHERE birthday &gt;= DATE_ADD(NOW(),INTERVAL 7 DAY);</p>
<p>理由：</p>
<ul>
<li>使用索引列上内置函数</li>
<li>索引失效：</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111628.66666154078568279806262611250732:50521228062829:2800:4B21859EB729572049C8FAFC9D0F359762F3C2CE35015DB2E6737656BA53C31A.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111628.66666154078568279806262611250732:50521228062829:2800:4B21859EB729572049C8FAFC9D0F359762F3C2CE35015DB2E6737656BA53C31A.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111628.66666154078568279806262611250732:50521228062829:2800:4B21859EB729572049C8FAFC9D0F359762F3C2CE35015DB2E6737656BA53C31A.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111628.66666154078568279806262611250732:50521228062829:2800:4B21859EB729572049C8FAFC9D0F359762F3C2CE35015DB2E6737656BA53C31A.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111628.66666154078568279806262611250732:50521228062829:2800:4B21859EB729572049C8FAFC9D0F359762F3C2CE35015DB2E6737656BA53C31A.png"
        title="img" /></p>
<ul>
<li>索引有效：</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111643.86708000394627663730620537378184:50521228062829:2800:2D0F694F927A89812B5F1ACA8AB8ACF35F8666B117269D8F26A8D58680B2633A.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111643.86708000394627663730620537378184:50521228062829:2800:2D0F694F927A89812B5F1ACA8AB8ACF35F8666B117269D8F26A8D58680B2633A.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111643.86708000394627663730620537378184:50521228062829:2800:2D0F694F927A89812B5F1ACA8AB8ACF35F8666B117269D8F26A8D58680B2633A.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111643.86708000394627663730620537378184:50521228062829:2800:2D0F694F927A89812B5F1ACA8AB8ACF35F8666B117269D8F26A8D58680B2633A.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111643.86708000394627663730620537378184:50521228062829:2800:2D0F694F927A89812B5F1ACA8AB8ACF35F8666B117269D8F26A8D58680B2633A.png"
        title="img" /></p>
<h2 id="避免在where中对字段进行表达式操作">避免在where中对字段进行表达式操作</h2>
<p>反例：</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE id+1-1=+1</p>
<p><strong>正例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE id=+1-1+1</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE id=1</p>
<p>理由：</p>
<ul>
<li>SQL解析时，如果字段相关的是表达式就进行全表扫描</li>
<li></li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111717.99721597714739349493735689204552:50521228062829:2800:B730A47102433BCB59552DE7B272342D5645DD3BA376A5134B4CD77B8C0955DF.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111717.99721597714739349493735689204552:50521228062829:2800:B730A47102433BCB59552DE7B272342D5645DD3BA376A5134B4CD77B8C0955DF.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111717.99721597714739349493735689204552:50521228062829:2800:B730A47102433BCB59552DE7B272342D5645DD3BA376A5134B4CD77B8C0955DF.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111717.99721597714739349493735689204552:50521228062829:2800:B730A47102433BCB59552DE7B272342D5645DD3BA376A5134B4CD77B8C0955DF.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111717.99721597714739349493735689204552:50521228062829:2800:B730A47102433BCB59552DE7B272342D5645DD3BA376A5134B4CD77B8C0955DF.png"
        title="img" /></p>
<ul>
<li>字段干净无表达式，索引生效</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111723.51677555163914612053523825340208:50521228062829:2800:88ED6F0B3BABE9B7DF17C40352F0FD6FE61250D6E7ED40F10D83C8E90DD7FE12.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111723.51677555163914612053523825340208:50521228062829:2800:88ED6F0B3BABE9B7DF17C40352F0FD6FE61250D6E7ED40F10D83C8E90DD7FE12.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111723.51677555163914612053523825340208:50521228062829:2800:88ED6F0B3BABE9B7DF17C40352F0FD6FE61250D6E7ED40F10D83C8E90DD7FE12.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111723.51677555163914612053523825340208:50521228062829:2800:88ED6F0B3BABE9B7DF17C40352F0FD6FE61250D6E7ED40F10D83C8E90DD7FE12.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111723.51677555163914612053523825340208:50521228062829:2800:88ED6F0B3BABE9B7DF17C40352F0FD6FE61250D6E7ED40F10D83C8E90DD7FE12.png"
        title="img" /></p>
<h2 id="避免在where子句中使用或操作符">避免在where子句中使用!=或&lt;&gt;操作符</h2>
<p>应尽量避免在where子句中使用!=或&lt;&gt;操作符，否则引擎将放弃使用索引而进行全表扫描。记住实现业务优先，实在没办法，就只能使用，并不是不能使用。如果不能使用，SQL也就无需支持了。</p>
<p>反例：</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE salary!=3000</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE salary&lt;&gt;3000</p>
<p>理由：</p>
<ul>
<li>使用!=和&lt;&gt;很可能会让索引失效</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111755.87767520236793350189779492802257:50521228062829:2800:A7380E9DCAAACE5F583325F93C0DA33E130ECD4B6DC1786B831274E93519894D.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111755.87767520236793350189779492802257:50521228062829:2800:A7380E9DCAAACE5F583325F93C0DA33E130ECD4B6DC1786B831274E93519894D.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111755.87767520236793350189779492802257:50521228062829:2800:A7380E9DCAAACE5F583325F93C0DA33E130ECD4B6DC1786B831274E93519894D.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111755.87767520236793350189779492802257:50521228062829:2800:A7380E9DCAAACE5F583325F93C0DA33E130ECD4B6DC1786B831274E93519894D.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422111755.87767520236793350189779492802257:50521228062829:2800:A7380E9DCAAACE5F583325F93C0DA33E130ECD4B6DC1786B831274E93519894D.png"
        title="img" /></p>
<h2 id="去重distinct过滤字段要少">去重distinct过滤字段要少</h2>
<p>#索引失效</p>
<p>EXPLAIN</p>
<p>SELECT DISTINCT * FROM student</p>
<p>#索引生效</p>
<p>EXPLAIN</p>
<p>SELECT DISTINCT id,NAME FROM student</p>
<p>EXPLAIN</p>
<p>SELECT DISTINCT NAME FROM student</p>
<p>理由：</p>
<ul>
<li>带distinct的语句占用cpu时间高于不带distinct的语句。因为当查询很多字段时，如果使用distinct，数据库引擎就会对数据进行比较，过滤掉重复数据，然而这个比较、过滤的过程会占用系统资源，如cpu时间</li>
</ul>
<h2 id="where中使用默认值代替null">where中使用默认值代替null</h2>
<p>环境准备：</p>
<p>#修改表，增加age字段，类型int，非空，默认值0</p>
<p>ALTER TABLE student ADD age INT NOT NULL DEFAULT 0;</p>
<p>#修改表，增加age字段的索引，名称为idx_age</p>
<p>ALTER TABLE student ADD INDEX idx_age (age);</p>
<p><strong>反例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE age IS NOT NULL</p>
<p><strong>正例：</strong></p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE age&gt;0</p>
<p>理由：</p>
<ul>
<li>并不是说使用了is null 或者 is not null 就会不走索引了，这个跟mysql版本以及查询成本都有关</li>
<li>如果mysql优化器发现，走索引比不走索引成本还要高，就会放弃索引，这些条件 !=，&lt;&gt;，is null，is not null经常被认为让索引失效，其实是因为一般情况下，查询的成本高，优化器自动放弃索引的</li>
<li>如果把null值，换成默认值，很多时候让走索引成为可能，同时，表达意思也相对清晰一点</li>
</ul>
<h1 id="heading-4"></h1>
<h1 id="高级sql优化">高级SQL优化</h1>
<h2 id="批量插入性能提升">批量插入性能提升</h2>
<p>大量数据提交，上千，上万，批量性能非常快，mysql独有</p>
<p>多条提交：</p>
<p>INSERT INTO student (id,NAME) VALUES(4,&lsquo;name1&rsquo;);</p>
<p>INSERT INTO student (id,NAME) VALUES(5,&lsquo;name2&rsquo;);</p>
<p><strong>批量提交：</strong></p>
<p>INSERT INTO student (id,NAME) VALUES(4,&lsquo;name1&rsquo;),(5,&lsquo;name2&rsquo;);</p>
<p>理由：</p>
<ul>
<li>默认新增SQL有事务控制，导致每条都需要事务开启和事务提交；而批量处理是一次事务开启和提交。自然速度飞升</li>
<li>数据量小体现不出来</li>
</ul>
<h2 id="批量删除优化">批量删除优化</h2>
<p>避免同时修改或删除过多数据，因为会造成cpu利用率过高，会造成锁表操作，从而影响别人对数据库的访问。</p>
<p>反例：</p>
<p>#一次删除10万或者100万+？</p>
<p>delete from student where id &lt;100000;</p>
<p>#采用单一循环操作，效率低，时间漫长</p>
<p>for（User user:list）{</p>
<p>delete from student;</p>
<p>}</p>
<p>正例：</p>
<p>#分批进行删除，如每次500</p>
<p>for(){</p>
<p>delete student where id&lt;500;</p>
<p>}</p>
<p>delete student where id&gt;=500 and id&lt;1000;</p>
<p>理由：</p>
<ul>
<li>一次性删除太多数据，可能造成锁表，会有lock wait timeout exceed的错误，所以建议分批操作</li>
</ul>
<h2 id="伪删除设计">伪删除设计</h2>
<p>商品状态（state）：1-上架、2-下架、3-删除</p>
<p>理由：</p>
<ul>
<li>这里的删除只是一个标识，并没有从数据库表中真正删除，可以作为历史记录备查</li>
<li>同时，一个大型系统中，表关系是非常复杂的，如电商系统中，商品作废了，但如果直接删除商品，其它商品详情，物流信息中可能都有其引用。</li>
<li>通过where state=1或者where state=2过滤掉数据，这样伪删除的数据用户就看不到了，从而不影响用户的使用</li>
<li>操作速度快，特别数据量很大情况下</li>
</ul>
<h2 id="heading-5"></h2>
<h2 id="提高group-by语句的效率">提高group by语句的效率</h2>
<p>可以在执行到该语句前，把不需要的记录过滤掉</p>
<p>反例：先分组，再过滤</p>
<p>select job，avg（salary） from employee</p>
<p>group by job</p>
<p>having job =&lsquo;president&rsquo; or job = &lsquo;managent&rsquo;;</p>
<p><strong>正例：先过滤，后分组</strong></p>
<p>select job，avg（salary） from employee</p>
<p>where job =&lsquo;president&rsquo; or job = &lsquo;managent&rsquo;</p>
<p>group by job;</p>
<h2 id="复合索引最左特性">复合索引最左特性</h2>
<p>创建复合索引，也就是多个字段</p>
<p>ALTER TABLE student ADD INDEX idx_name_salary (NAME,salary)</p>
<p>满足复合索引的左侧顺序，哪怕只是部分，复合索引生效</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE NAME=&lsquo;name1&rsquo;</p>
<p>没有出现左边的字段，则不满足最左特性，索引失效</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE salary=3000</p>
<p>复合索引全使用，按左侧顺序出现 name,salary，索引生效</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE NAME=&lsquo;陈子枢&rsquo; AND salary=3000</p>
<p>虽然违背了最左特性，但MYSQL执行SQL时会进行优化，底层进行颠倒优化</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student WHERE salary=3000 AND NAME=&lsquo;name1&rsquo;</p>
<p>理由：</p>
<ul>
<li>复合索引也称为联合索引</li>
<li>当我们创建一个联合索引的时候，如(k1,k2,k3)，相当于创建了（k1）、(k1,k2)和(k1,k2,k3)三个索引，这就是最左匹配原则</li>
<li>联合索引不满足最左原则，索引一般会失效，但是这个还跟Mysql优化器有关的</li>
</ul>
<h2 id="heading-6"></h2>
<h2 id="排序字段创建索引">排序字段创建索引</h2>
<p>什么样的字段才需要创建索引呢？原则就是where和order by中常出现的字段就创建索引。</p>
<p>#使用*，包含了未索引的字段，导致索引失效</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student ORDER BY NAME;</p>
<p>EXPLAIN</p>
<p>SELECT * FROM student ORDER BY NAME,salary</p>
<p>#name字段有索引</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student ORDER BY NAME</p>
<p>#name和salary复合索引</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student ORDER BY NAME,salary</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student ORDER BY salary,NAME</p>
<p>#排序字段未创建索引，性能就慢</p>
<p>EXPLAIN</p>
<p>SELECT id,NAME FROM student ORDER BY sex</p>
<h2 id="删除冗余和重复的索引">删除冗余和重复的索引</h2>
<p>SHOW INDEX FROM student</p>
<p>#创建索引index_name</p>
<p>ALTER TABLE student ADD INDEX index_name (NAME)</p>
<p>#删除student表的index_name索引</p>
<p>DROP INDEX index_name ON student ;</p>
<p>#修改表结果，删除student表的index_name索引</p>
<p>ALTER TABLE student DROP INDEX index_name ;</p>
<p>#主键会自动创建索引，删除主键索引</p>
<p>ALTER TABLE student DROP PRIMARY KEY ;</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422112151.20020993916009081085766960518663:50521228062829:2800:A64B3826F29B8C9B8ABA1D236ADD9B305175A921111541E31821133978F067AD.png"
        data-srcset="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422112151.20020993916009081085766960518663:50521228062829:2800:A64B3826F29B8C9B8ABA1D236ADD9B305175A921111541E31821133978F067AD.png, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422112151.20020993916009081085766960518663:50521228062829:2800:A64B3826F29B8C9B8ABA1D236ADD9B305175A921111541E31821133978F067AD.png 1.5x, https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422112151.20020993916009081085766960518663:50521228062829:2800:A64B3826F29B8C9B8ABA1D236ADD9B305175A921111541E31821133978F067AD.png 2x"
        data-sizes="auto"
        alt="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/132/978/613/0220086000132978613.20210422112151.20020993916009081085766960518663:50521228062829:2800:A64B3826F29B8C9B8ABA1D236ADD9B305175A921111541E31821133978F067AD.png"
        title="img" /></p>
<h2 id="不要有超过5个以上的表连接">不要有超过5个以上的表连接</h2>
<ul>
<li>关联的表个数越多，编译的时间和开销也就越大</li>
<li>每次关联内存中都生成一个临时表</li>
<li>应该把连接表拆开成较小的几个执行，可读性更高</li>
<li>如果一定需要连接很多表才能得到数据，那么意味着这是个糟糕的设计了</li>
<li>阿里规范中，建议多表联查三张表以下</li>
</ul>
<h2 id="inner-join-left-joinright-join优先使用inner-join">inner join 、left join、right join，优先使用inner join</h2>
<p>三种连接如果结果相同，优先使用inner join，如果使用left join左边表尽量小</p>
<ul>
<li>inner join 内连接，只保留两张表中完全匹配的结果集</li>
<li>left join会返回左表所有的行，即使在右表中没有匹配的记录</li>
<li>right join会返回右表所有的行，即使在左表中没有匹配的记录</li>
</ul>
<p>理由：</p>
<ul>
<li>如果inner join是等值连接，返回的行数比较少，所以性能相对会好一点</li>
<li>同理，使用了左连接，左边表数据结果尽量小，条件尽量放到左边处理，意味着返回的行数可能比较少。这是mysql优化原则，就是小表驱动大表，小的数据集驱动大的数据集，从而让性能更优</li>
</ul>
<h2 id="heading-7"></h2>
<h2 id="in子查询的优化">in子查询的优化</h2>
<p>日常开发实现业务需求可以有两种方式实现：</p>
<ul>
<li>一种使用数据库SQL脚本实现</li>
<li>一种使用程序实现
如需求：查询所有部门的所有员工：</li>
</ul>
<p>#in子查询</p>
<p>SELECT * FROM tb_user WHERE dept_id IN (SELECT id FROM tb_dept);</p>
<p>#这样写等价于：</p>
<p>#先查询部门表</p>
<p>SELECT id FROM tb_dept</p>
<p>#再由部门dept_id，查询tb_user的员工</p>
<p>SELECT * FROM tb_user u,tb_dept d WHERE u.dept_id = d.id</p>
<p>假设表A表示某企业的员工表，表B表示部门表，查询所有部门的所有员工，很容易有以下程序实现，可以抽象成这样的一个嵌套循环：</p>
<p>List&lt;&gt; resultSet;</p>
<p>for(int i=0;i&lt;B.length;i++) {</p>
<p>for(int j=0;j&lt;A.length;j++) {</p>
<p>if(A[i].id==B[j].id) {</p>
<p>resultSet.add(A[i]);</p>
<p>break;</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>上面的需求使用SQL就远不如程序实现，特别当数据量巨大时。</p>
<p>理由：</p>
<ul>
<li>数据库最费劲的就是程序链接的释放。假设链接了两次，每次做上百万次的数据集查询，查完就结束，这样就只做了两次；相反建立了上百万次链接，申请链接释放反复重复，就会额外花费很多实际，这样系统就受不了了，慢，卡顿</li>
</ul>
<h2 id="尽量使用union-all替代union">尽量使用union all替代union</h2>
<p>反例：</p>
<p>SELECT * FROM student</p>
<p>UNION</p>
<p>SELECT * FROM student</p>
<p><strong>正例：</strong></p>
<p>SELECT * FROM student</p>
<p>UNION ALL</p>
<p>SELECT * FROM student</p>
<p>理由：</p>
<ul>
<li>union和union all的区别是，union会自动去掉多个结果集合中的重复结果，而union all则将所有的结果全部显示出来，不管是不是重复</li>
<li>union：对两个结果集进行并集操作，不包括重复行，同时进行默认规则的排序</li>
<li>union在进行表链接后会筛选掉重复的记录，所以在表链接后会对所产生的结果集进行排序运算，删除重复的记录再返回结果。实际大部分应用中是不会产生重复的记录，最常见的是过程表与历史表UNION</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-01-04</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/mysql-sqlbest/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1/" class="prev" rel="prev" title="接口幂等设计"><i class="fas fa-angle-left fa-fw"></i>接口幂等设计</a>
            <a href="/mysql-index/" class="next" rel="next" title="MySQL索引">MySQL索引<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.88.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">皮邱</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
